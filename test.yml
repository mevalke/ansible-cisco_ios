---
- name: Configure L2 interfaces on IOS switches
  hosts: all
  vars_files: ios_vars.yml
  gather_facts: false
  connection: local
  tasks:
  tasks:
  - name: Construct list of allowed vlans
    set_fact:
      global_allowed_vlans: "{{ global_allowed_vlans + [ item.id ] }}"
    loop: "{{ global_tagged_vlans }}"
  # 
  # - name: Configure interface as trunk
  #   cisco.ios.ios_config:
  #     parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
  #     lines: 
  #     - no switchport mode access
  #     - no switchport access vlan
  #     - switchport trunk encapsulation dot1q
  #     - switchport mode trunk
  #     - switchport trunk allowed vlan {{ global_allowed_vlans | join(',') }}
  #   notify: "Write Config"
  #   loop: "{{ sw_tagged_ports }}"
  # 
  - name: Configure interface as trunk
    cisco.ios.ios_l2_interfaces:
      config:
      - name: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
        trunk:
          allowed_vlans: "{{ global_allowed_vlans | join(',') }}"
          encapsulation: dot1q
      state: replaced
    notify: "Write Config"
    loop: "{{ sw_tagged_ports }}"
  # - name: Configure allowed vlans on {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
    # cisco.ios.ios_config:
      # parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
      # lines:
      # - switchport trunk allowed vlans {{ global_allowed_vlans | join(',') }}
    # notify: "Write Config"
    # loop: "{{ sw_tagged_ports }}"

  # - name: Configure interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }} as access port
    # cisco.ios.ios_config:
      # parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
      # lines: interface {{ sw1_switch_interface_prefix }}{{ item }} shutdown
    # notify: "Write Config"
    # loop: "{{ sw_untagged_ports }}"

  # - name: Admin shut interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
    # cisco.ios.ios_config:
      # parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
      # lines: "{{ global_untagged_port_conf }} + {{ item.port_conf + [item.desc] }}"
    # notify: "Write Config"
    # loop: "{{ sw_untagged_ports }}"
  handlers: 
  - name: Write Config
    cisco.ios.ios_command:
      commands:
      - write

