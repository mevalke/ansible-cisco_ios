---
- name: Configure L2 interfaces on IOS switches
  hosts: all
  vars_files: vars.yml
  gather_facts: false
  connection: local
  tasks:
  tasks:
  - name: Construct list of allowed vlans
    set_fact:
      global_allowed_vlans: "{{ global_allowed_vlans + [ item.id ] }}"
    loop: "{{ global_tagged_vlans }}"

  - name: Configure interface as trunk
    cisco.ios.ios_config:
      parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
      lines:
      - switchport trunk encapsulation dot1q
      - switchport mode trunk
      - switchport trunk allowed vlan {{ global_allowed_vlans | join(',') }}
      - "{{ item.desc }}"
      - "{{ item.port_conf[0] }}"
      - "{{ item.port_conf[1] }}"
      - "{{ item.port_conf[2] }}"
      - "{{ item.port_conf[3] }}"
      - no shutdown
    notify: "Write Config"
    loop: "{{ sw_tagged_ports }}"

  - name: Configure interface as access port
    cisco.ios.ios_config:
      parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item.name }}
      lines:
      - no switchport trunk allowed vlan
      - no switchport mode trunk
      - no switchport trunk encapsulation
      - switchport mode access
      - "{{ item.desc }}"
      - "{{ item.port_conf[0] }}"
      - "{{ item.port_conf[1] }}"
      - "{{ item.port_conf[2] }}"
      - "{{ item.port_conf[3] }}"
      - no shutdown
    notify: "Write Config"
    loop: "{{ sw_untagged_ports }}"

  - name: construct list of used ports for sw1
    set_fact:
        sw1_used_ports: "{{ sw1_used_ports + [ item.name ] }}"
    loop: "{{ sw1_interfaces }}"

  - name: construct list of used ports for sw2
    set_fact:
      sw2_used_ports: "{{ sw2_used_ports + [ item.name ] }}"
    loop: "{{ sw2_interfaces }}"

  - name: construct list of used ports for sw3
    set_fact:
      sw3_used_ports: "{{ sw3_used_ports + [ item.name ] }}"
    loop: "{{ sw3_interfaces }}"

  - name: construct list of used ports for sw4
    set_fact:
      sw4_used_ports: "{{ sw4_used_ports + [ item.name ] }}"
    loop: "{{ sw4_interfaces }}"

  - name: Admin shut interface
    cisco.ios.ios_config:
      parents: interface {{ vars[ inventory_hostname+'_switch_interface_prefix' ] }}{{ item }}
      lines:
      - description admin shut
      - no switchport mode
      - no switchport trunk allowed vlan
      - no switchport trunk encapsulation
      - shutdown
    notify: "Write Config"
    loop: "{{ vars[ inventory_hostname+'_switch_ports_all' ] | difference(vars[ inventory_hostname+'_used_ports' ]) }}"

  handlers:
  - name: Write Config
    cisco.ios.ios_command:
      commands:
      - write
